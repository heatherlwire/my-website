<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Canonical redirect (top-level only) -->
    <script>
        if (window.top === window.self) {
            if (location.hostname === "wirelearningsolutions.com") {
                location.replace(
                    "https://www.wirelearningsolutions.com" +
                    location.pathname +
                    location.search
                );
            }
        }
    </script>

    <meta charset="UTF-8" />
    <title>Your Adaptive Learning Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
        :root {
            --bg-0: #0a0f1a;
            --bg-1: #0e1526;
            --bg-2: #101b33;
            --card-bg: #141f38;
            --ink-0: #e8f1ff;
            --ink-1: #b9c8e8;
            --good: #22c55e;
            --warn: #f59e0b;
            --fail: #ef4444;
            --action: #0ea5e9;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
            background: linear-gradient(180deg,#07101e 0%,#0b1628 100%);
            color: var(--ink-0);
            padding: 28px;
        }

        h1 {
            margin-top: 0;
            text-align: center;
            font-size: 30px;
        }

        .muted {
            color: var(--ink-1);
        }

        /* Dashboard layout */
        .dash-container {
            max-width: 850px;
            margin: 0 auto;
            margin-top: 24px;
        }

        .comp-card {
            background: var(--card-bg);
            padding: 18px;
            border-radius: 10px;
            margin-bottom: 18px;
        }

        .comp-title {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .stat-row {
            margin: 4px 0;
        }

        .next-box {
            margin-top: 28px;
            padding: 18px;
            background: var(--card-bg);
            border-radius: 10px;
        }

        .big-btn {
            margin-top: 24px;
            width: 100%;
            background: var(--action);
            border: none;
            color: white;
            padding: 14px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.2s;
        }

            .big-btn:hover {
                background: #0c8dc8;
            }

        .small-btn {
            margin-top: 12px;
            background: #22304a;
            border: none;
            padding: 10px;
            border-radius: 8px;
            color: var(--ink-1);
            cursor: pointer;
        }

        .status-good {
            color: var(--good);
        }

        .status-warn {
            color: var(--warn);
        }

        .status-fail {
            color: var(--fail);
        }
    </style>
</head>

<body>
    <h1>Your Adaptive Learning Progress</h1>
    <p class="muted" id="helloLine"></p>

    <div class="dash-container" id="dash"></div>

    <script>
        /* =========================================
           CONFIG
        ========================================= */
        const PROXY_URL =
            "https://kh2do5aivc7hqegavqjeiwmd7q0smjqq.lambda-url.us-east-1.on.aws";

        const RULES_URL =
            "https://www.wirelearningsolutions.com/adaptive_rules.json";

        /* =========================================
           IDENTITY
        ========================================= */
        const qs = new URLSearchParams(location.search);

        let learnerName = qs.get("learnerName") || localStorage.getItem("learnerName") || "";
        let email = qs.get("email") || localStorage.getItem("learnerEmail") || "";
        let sid = qs.get("sid") || localStorage.getItem("sessionId") || "";

        if (learnerName) localStorage.setItem("learnerName", learnerName);
        if (email) localStorage.setItem("learnerEmail", email);
        if (sid) localStorage.setItem("sessionId", sid);

        document.getElementById("helloLine").textContent =
            learnerName ? `Welcome back, ${learnerName}.` : `Welcome.`;

        function withIdentity(url) {
            const sep = url.includes("?") ? "&" : "?";
            return (
                url +
                sep +
                "learnerName=" + encodeURIComponent(learnerName || "") +
                "&email=" + encodeURIComponent(email || "") +
                "&sid=" + encodeURIComponent(sid || "")
            );
        }

        /* =========================================
           LOAD RULES + SUMMARY
        ========================================= */
        async function loadRules() {
            const res = await fetch(RULES_URL, { cache: "no-store" });
            return res.json();
        }

        async function loadSummary() {
            const url =
                PROXY_URL +
                "?mode=summary" +
                (learnerName ? "&learnerName=" + encodeURIComponent(learnerName) : "") +
                (email ? "&email=" + encodeURIComponent(email) : "");

            const res = await fetch(url);
            if (!res.ok) return {};
            return res.json();
        }

        /* =========================================
           DETECT CURRENT COMPETENCY
        ========================================= */
        function detectCurrent(summary) {
            const C1 = summary.C1 || {};
            const C2 = summary.C2 || {};
            const C3 = summary.C3 || {};

            const m1 = C1.mastery;
            const f1 = C1.finalized;
            const m2 = C2.mastery;
            const f2 = C2.finalized;
            const m3 = C3.mastery;
            const f3 = C3.finalized;

            // Still in C1
            if (!m1 && !f1) return "C1";
            if (m1 && m1 !== "Mastery" && !f1) return "C1";

            // Move to C2
            if ((m1 === "Mastery" || f1) && (!m2 && !f2)) return "C2";
            if ((m1 === "Mastery" || f1) && (m2 && m2 !== "Mastery" && !f2)) return "C2";

            // Move to C3
            if ((m1 === "Mastery" || f1) &&
                (m2 === "Mastery" || f2) &&
                (!m3 && !f3)) return "C3";
            if ((m1 === "Mastery" || f1) &&
                (m2 === "Mastery" || f2) &&
                (m3 && m3 !== "Mastery" && !f3)) return "C3";

            return "C3";
        }

        /* =========================================
           APPLY RULES
        ========================================= */
        function buildRoutes(summary, rules) {
            const current = detectCurrent(summary);
            const compRules = rules[current];

            const result = { current, pending: [] };

            const state = summary[current] || {};
            const mastery = state.mastery || null;
            const finalized = !!state.finalized;
            const missed = Array.isArray(state.missed) ? state.missed : [];

            function pushRoute(routeObj) {
                const type = Object.keys(routeObj)[0];
                const target = routeObj[type];
                result.pending.push({ type, target });
            }

            let matched = false;

            for (const rule of compRules) {
                const cond = rule.if || {};

                if (cond.finalized === true && finalized === true) {
                    (rule.then || []).forEach(step => {
                        if (step.route) pushRoute(step.route);
                    });
                    matched = true;
                    break;
                }

                if (cond.mastery && mastery === cond.mastery) {
                    for (const step of rule.then || []) {
                        if (step.forEach === "missed") {
                            missed.forEach(item => {
                                (step.do || []).forEach(d => {
                                    const r = JSON.parse(JSON.stringify(d.route));
                                    for (const k in r) r[k] = r[k].replace("{item}", item);
                                    pushRoute(r);
                                });
                            });
                        }
                        if (step.route) pushRoute(step.route);
                    }
                    matched = true;
                    break;
                }

                if (Array.isArray(cond.masteryIn) && cond.masteryIn.includes(mastery)) {
                    for (const step of rule.then || []) {
                        if (Array.isArray(step.forEach)) {
                            step.forEach.forEach(item => {
                                (step.do || []).forEach(d => {
                                    const r = JSON.parse(JSON.stringify(d.route));
                                    for (const k in r) r[k] = r[k].replace("{item}", item);
                                    pushRoute(r);
                                });
                            });
                        }
                        if (step.route) pushRoute(step.route);
                    }
                    matched = true;
                    break;
                }
            }

            if (!matched) {
                result.pending.push({ type: "assessment", target: `${current}-test` });
            }

            return result;
        }

        /* =========================================
           ROUTE → URL
        ========================================= */
        function resolveRoute(route) {
            const { type, target } = route;

            if (type === "go") {
                if (target === "program-complete") return "program-complete.html";
                if (/-test$/.test(target)) return `${target}/story.html`;
                return `${target}.html`;
            }

            if (type === "assessment") return `${target}/story.html`;
            if (type === "content") return `content/${target}-content.html`;
            if (type === "apply") {
                const item = target;
                return `apply/${item}/${item}-apply.html`;
            }

            return `${target}.html`;
        }

        /* =========================================
           BUILD DASHBOARD
        ========================================= */
        function renderDashboard(summary, routes) {
            const dash = document.getElementById("dash");

            function masteryColor(m) {
                if (m === "Mastery") return "status-good";
                if (m === "Proficient") return "status-warn";
                return "status-fail";
            }

            function cardHTML(id, data) {
                return `
                        <div class="comp-card">
                            <div class="comp-title">${id}</div>
                            <div class="stat-row">Status:
                                <span class="${masteryColor(data.mastery)}">${data.mastery || "Not Started"}</span>
                            </div>
                            <div class="stat-row">Missed:
                                ${data.missed && data.missed.length
                        ? data.missed.join(", ")
                        : "None"}
                            </div>
                        </div>
                    `;
            }

            const next = routes.pending.length ? routes.pending[0] : null;
            const nextUrl = next ? resolveRoute(next) : "C1-test/story.html";

            dash.innerHTML = `
                    ${cardHTML("C1", summary.C1 || {})}
                    ${cardHTML("C2", summary.C2 || {})}
                    ${cardHTML("C3", summary.C3 || {})}

                    <div class="next-box">
                        <div style="font-size: 20px; margin-bottom: 8px;">Next Step</div>
                        <div class="muted">${next ? `${next.type.toUpperCase()}: ${next.target}` : "Start C1"}</div>
                    </div>

                    <button class="big-btn" onclick="window.location.href=withIdentity('${nextUrl}')">
                        Continue
                    </button>

                    <button class="small-btn"
                        onclick="localStorage.clear(); window.location.href='index.html';">
                        Reset & Return to Start
                    </button>
                `;
        }

        /* =========================================
           MAIN
        ========================================= */
        (async () => {
            const rules = await loadRules();
            const summary = await loadSummary();
            const routes = buildRoutes(summary, rules);
            renderDashboard(summary, routes);
        })();
    </script>
</body>
</html>
