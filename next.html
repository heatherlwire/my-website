<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Canonical redirect (top-level only) -->
    <script>
        if (window.top === window.self) {
            if (location.hostname === "wirelearningsolutions.com") {
                location.replace(
                    "https://www.wirelearningsolutions.com" +
                    location.pathname +
                    location.search
                );
            }
        }
    </script>

    <meta charset="UTF-8" />
    <title>Your Adaptive Learning Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
        :root {
            --bg-0: #0a0f1a;
            --bg-1: #0e1526;
            --bg-2: #101b33;
            --card-bg: #141f38;
            --ink-0: #e8f1ff;
            --ink-1: #b9c8e8;
            --good: #22c55e;
            --warn: #f59e0b;
            --fail: #ef4444;
            --action: #0ea5e9;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
            background: linear-gradient(180deg,#07101e 0%,#0b1628 100%);
            color: var(--ink-0);
            padding: 28px;
        }

        h1 {
            margin-top: 0;
            text-align: center;
            font-size: 30px;
        }

        .muted {
            color: var(--ink-1);
        }

        .dash-container {
            max-width: 850px;
            margin: 0 auto;
            margin-top: 24px;
        }

        .comp-card {
            background: var(--card-bg);
            padding: 18px;
            border-radius: 10px;
            margin-bottom: 18px;
        }

        .comp-title {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .stat-row {
            margin: 4px 0;
        }

        .next-box {
            margin-top: 28px;
            padding: 18px;
            background: var(--card-bg);
            border-radius: 10px;
        }

        .big-btn {
            margin-top: 16px;
            width: 100%;
            background: var(--action);
            border: none;
            color: white;
            padding: 14px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.2s;
        }

            .big-btn:hover {
                background: #0c8dc8;
            }

        .off-btn {
            background: #374151;
        }

            .off-btn:hover {
                background: #4b5563;
            }

        .small-btn {
            margin-top: 16px;
            background: #22304a;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            color: var(--ink-1);
            cursor: pointer;
        }

        .status-good {
            color: var(--good);
        }

        .status-warn {
            color: var(--warn);
        }

        .status-fail {
            color: var(--fail);
        }
    </style>
</head>

<body>
    <h1>Your Adaptive Learning Progress</h1>
    <p class="muted" id="helloLine"></p>

    <div class="dash-container" id="dash"></div>

    <script>
        /* =========================================
           CONFIG
        ========================================= */
        const PROXY_URL =
            "https://kh2do5aivc7hqegavqjeiwmd7q0smjqq.lambda-url.us-east-1.on.aws";

        const RULES_URL =
            "https://www.wirelearningsolutions.com/adaptive_rules.json";

        const EXT_NS = "https://acbl.wirelxdfirm.com/extensions/";

        /* =========================================
           IDENTITY
        ========================================= */
        const qs = new URLSearchParams(location.search);

        let learnerName = qs.get("learnerName") || localStorage.getItem("learnerName") || "";
        let email = qs.get("email") || localStorage.getItem("learnerEmail") || "";
        let sid = qs.get("sid") || localStorage.getItem("sessionId") || "";

        if (learnerName) localStorage.setItem("learnerName", learnerName);
        if (email) localStorage.setItem("learnerEmail", email);
        if (sid) localStorage.setItem("sessionId", sid);

        document.getElementById("helloLine").textContent =
            learnerName ? `Welcome back, ${learnerName}.` : `Welcome.`;

        function withIdentity(url) {
            const sep = url.includes("?") ? "&" : "?";
            return (
                url +
                sep +
                "learnerName=" + encodeURIComponent(learnerName || "") +
                "&email=" + encodeURIComponent(email || "") +
                "&sid=" + encodeURIComponent(sid || "")
            );
        }

        /* =========================================
           LOAD RULES + SUMMARY
        ========================================= */
        async function loadRules() {
            const res = await fetch(RULES_URL, { cache: "no-store" });
            if (!res.ok) throw new Error("Failed to load adaptive rules");
            return res.json();
        }

        async function loadSummary() {
            const url =
                PROXY_URL +
                "?mode=summary" +
                (learnerName ? "&learnerName=" + encodeURIComponent(learnerName) : "") +
                (email ? "&email=" + encodeURIComponent(email) : "");

            const res = await fetch(url);
            if (!res.ok) return {};
            const data = await res.json();
            return {
                C1: data.C1 || {},
                C2: data.C2 || {},
                C3: data.C3 || {}
            };
        }

        /* =========================================
           DETECT CURRENT COMPETENCY
        ========================================= */
        function detectCurrent(summary) {
            const C1 = summary.C1 || {};
            const C2 = summary.C2 || {};
            const C3 = summary.C3 || {};

            const m1 = C1.mastery;
            const f1 = C1.finalized;
            const m2 = C2.mastery;
            const f2 = C2.finalized;
            const m3 = C3.mastery;
            const f3 = C3.finalized;

            // Still in C1
            if (!m1 && !f1) return "C1";
            if (m1 && m1 !== "Mastery" && !f1) return "C1";

            // Move to C2
            if ((m1 === "Mastery" || f1) && (!m2 && !f2)) return "C2";
            if ((m1 === "Mastery" || f1) && (m2 && m2 !== "Mastery" && !f2)) return "C2";

            // Move to C3
            if ((m1 === "Mastery" || f1) &&
                (m2 === "Mastery" || f2) &&
                (!m3 && !f3)) return "C3";
            if ((m1 === "Mastery" || f1) &&
                (m2 === "Mastery" || f2) &&
                (m3 && m3 !== "Mastery" && !f3)) return "C3";

            return "C3";
        }

        /* =========================================
           APPLY RULES (uses your JSON)
        ========================================= */
        function buildRoutes(summary, rules) {
            const current = detectCurrent(summary);
            const compRules = rules[current];

            const result = { current, pending: [] };

            const state = summary[current] || {};
            const mastery = state.mastery || null;
            const finalized = !!state.finalized;
            const missed = Array.isArray(state.missed) ? state.missed : [];

            function pushRoute(routeObj) {
                const type = Object.keys(routeObj)[0];
                const target = routeObj[type];
                result.pending.push({ type, target });
            }

            if (!Array.isArray(compRules) || compRules.length === 0) {
                // No rules defined, default to pretest for that comp
                result.pending.push({ type: "assessment", target: `${current}-test` });
                return result;
            }

            let matched = false;

            for (const rule of compRules) {
                const cond = rule.if || {};

                // finalized = true → off-ramp in JSON
                if (cond.finalized === true && finalized === true) {
                    for (const step of rule.then || []) {
                        if (step.route) pushRoute(step.route);
                    }
                    matched = true;
                    break;
                }

                // Mastery exact match
                if (cond.mastery && mastery === cond.mastery) {
                    for (const step of rule.then || []) {
                        if (step.forEach === "missed") {
                            // Proficient: only missed subs
                            missed.forEach(item => {
                                (step.do || []).forEach(d => {
                                    const r = JSON.parse(JSON.stringify(d.route));
                                    for (const k in r) r[k] = r[k].replace("{item}", item);
                                    pushRoute(r);
                                });
                            });
                        }
                        if (step.route) pushRoute(step.route);
                    }
                    matched = true;
                    break;
                }

                // masteryIn (Emerging / Failing → full remediation of all subs)
                if (Array.isArray(cond.masteryIn) && cond.masteryIn.includes(mastery)) {
                    for (const step of rule.then || []) {
                        if (Array.isArray(step.forEach)) {
                            step.forEach.forEach(item => {
                                (step.do || []).forEach(d => {
                                    const r = JSON.parse(JSON.stringify(d.route));
                                    for (const k in r) r[k] = r[k].replace("{item}", item);
                                    pushRoute(r);
                                });
                            });
                        }
                        if (step.route) pushRoute(step.route);
                    }
                    matched = true;
                    break;
                }
            }

            // If no rule matched: treat as pretest for that competency
            if (!matched) {
                result.pending.push({ type: "assessment", target: `${current}-test` });
            }

            return result;
        }

        /* =========================================
           ROUTE → URL (matches your folder structure)
        ========================================= */
        function resolveRoute(route) {
            const { type, target } = route;

            if (type === "go") {
                if (target === "program-complete") return "program-complete.html";
                if (/-test$/.test(target)) return `${target}/story.html`;
                return `${target}.html`;
            }

            if (type === "assessment") return `${target}/story.html`;

            if (type === "content") {
                // target like "C1a"
                return `content/${target}-content.html`;
            }

            if (type === "apply") {
                // target like "C1a"
                const item = target;
                return `apply/${item}/${item}-apply.html`;
            }

            return `${target}.html`;
        }

        /* =========================================
           ACCEPT MASTERY OFF-RAMP
        ========================================= */
        async function acceptMastery(compId) {
            try {
                const actorName = learnerName || email || "Anonymous";
                const mbox = "mailto:" + encodeURIComponent(actorName) + "@wirelxdfirm.com";

                const stmt = {
                    actor: {
                        name: actorName,
                        mbox: mbox
                    },
                    verb: {
                        id: "http://adlnet.gov/expapi/verbs/experienced",
                        display: { "en-US": "experienced" }
                    },
                    object: {
                        id: `https://acbl.wirelxdfirm.com/activities/${compId}/finalize`,
                        definition: {
                            name: { "en-US": "Accepted Mastery Level" },
                            description: {
                                "en-US": "Learner chose to accept current mastery level and skip remaining remediation."
                            },
                            type: "http://adlnet.gov/expapi/activities/assessment"
                        },
                        objectType: "Activity"
                    },
                    result: {
                        extensions: {
                            [EXT_NS + "competencyId"]: compId,
                            [EXT_NS + "finalized"]: true
                        }
                    },
                    context: {
                        registration: sid || undefined
                    },
                    timestamp: new Date().toISOString()
                };

                // Write statement via Lambda
                await fetch(PROXY_URL + "?mode=write", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(stmt)
                });

                // Local hint
                localStorage.setItem(compId + ".finalized", "true");

                // Off-ramp routing: go straight to next competency test
                let nextUrl;
                if (compId === "C1") {
                    nextUrl = "C2-test/story.html";
                } else if (compId === "C2") {
                    nextUrl = "C3-test/story.html";
                } else {
                    nextUrl = "program-complete.html";
                }

                window.location.href = withIdentity(nextUrl);

            } catch (err) {
                console.error("Accept mastery failed:", err);
                alert("We could not finalize your mastery level. Please try again.");
            }
        }

        /* =========================================
           DASHBOARD RENDER
        ========================================= */
        function renderDashboard(summary, routes) {
            const dash = document.getElementById("dash");

            function masteryColor(m) {
                if (m === "Mastery") return "status-good";
                if (m === "Proficient") return "status-warn";
                if (!m) return "";
                return "status-fail";
            }

            function cardHTML(id, data) {
                return `
                        <div class="comp-card">
                            <div class="comp-title">${id}</div>
                            <div class="stat-row">Status:
                                <span class="${masteryColor(data.mastery)}">${data.mastery || "Not Started"}</span>
                            </div>
                            <div class="stat-row">Missed:
                                ${data.missed && data.missed.length
                        ? data.missed.join(", ")
                        : "None"}
                            </div>
                        </div>
                    `;
            }

            const next = routes.pending.length ? routes.pending[0] : null;
            const nextUrl = next ? resolveRoute(next) : "C1-test/story.html";

            const currentComp = routes.current;
            const currentState = summary[currentComp] || {};
            const mastery = currentState.mastery || null;
            const finalized = !!currentState.finalized;

            // Show off-ramp for any non-Mastery status that is not already finalized
            const showOffRamp =
                mastery && mastery !== "Mastery" && !finalized;

            const offRampButton = showOffRamp
                ? `<button class="big-btn off-btn" onclick="acceptMastery('${currentComp}')">
                            Accept Mastery Level (Skip Remaining Remediation)
                       </button>`
                : "";

            dash.innerHTML = `
                    ${cardHTML("C1", summary.C1 || {})}
                    ${cardHTML("C2", summary.C2 || {})}
                    ${cardHTML("C3", summary.C3 || {})}

                    <div class="next-box">
                        <div style="font-size: 20px; margin-bottom: 8px;">Next Step</div>
                        <div class="muted" style="margin-bottom: 10px;">
                            ${next
                    ? `${next.type.toUpperCase()}: ${next.target}`
                    : "Start with C1 pretest."}
                        </div>

                        <button class="big-btn" onclick="window.location.href=withIdentity('${nextUrl}')">
                            Continue
                        </button>

                        ${offRampButton}
                    </div>

                    <button class="small-btn"
                        onclick="localStorage.clear(); window.location.href='index.html';">
                        Reset & Return to Start
                    </button>
                `;
        }

        /* =========================================
           MAIN
        ========================================= */
        (async () => {
            try {
                const rules = await loadRules();
                const summary = await loadSummary();
                const routes = buildRoutes(summary, rules);
                renderDashboard(summary, routes);
            } catch (err) {
                console.error(err);
                const dash = document.getElementById("dash");
                dash.innerHTML = `
                        <div class="comp-card">
                            <div class="stat-row status-fail">
                                We had trouble loading your progress. Starting you at C1 pretest.
                            </div>
                            <button class="big-btn" onclick="window.location.href=withIdentity('C1-test/story.html')">
                                Go to C1 Pretest
                            </button>
                        </div>
                    `;
            }
        })();
    </script>
</body>
</html>
