<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Analyzing your progress</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-0: #0a0f1a;
      --bg-1: #0e1526;
      --bg-2: #0f1b33;
      --ink-0: #e8f1ff;
      --ink-1: #b9c8e8;
      --sky-1: #0ea5e9;
      --sky-2: #22d3ee;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
      --focus: #93c5fd;
      --shadow: 0 10px 24px rgba(0,0,0,.35);
    }

    body {
      margin: 0;
      color: var(--ink-0);
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 800px at 70% -10%,rgba(34,211,238,.10),transparent 60%),
                  radial-gradient(1000px 600px at -10% 20%,rgba(14,165,233,.15),transparent 55%),
                  linear-gradient(180deg,#07101e 0%,#0a1322 50%,#0b1628 100%);
      min-height: 100dvh;
    }

    header { padding: 28px 24px 10px; }
    .title-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    h1 {
      margin: 0;
      font-size: clamp(22px,2.4vw,28px);
      background: linear-gradient(90deg,var(--ink-0),#cfe8ff);
      -webkit-background-clip: text;
      color: transparent;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(14,165,233,.10);
      border: 1px solid rgba(34,211,238,.35);
    }

    .dot {
      width: 10px; height: 10px;
      border-radius: 50%; background: var(--warn);
    }
    .dot.ok { background: var(--ok); box-shadow: 0 0 0 0 rgba(34,197,94,.6); animation: pulse 1.8s ease-out infinite; }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(34,197,94,.5); }
      70% { box-shadow: 0 0 0 10px rgba(34,197,94,0); }
      100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
    }

    .wrap { padding: 6px 24px 32px; max-width: 1100px; margin: 0 auto; }
    .card {
      background: linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015)),var(--bg-1);
      border: 1px solid rgba(148,163,184,.15);
      border-radius: 14px; padding: 16px; margin: 16px 0;
      box-shadow: var(--shadow); backdrop-filter: blur(6px);
    }

    .muted { color: var(--ink-1); }
    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }

    button {
      padding: 10px 16px; border-radius: 10px; cursor: pointer;
      font-size: 15px; border: 1px solid rgba(148,163,184,.35);
      background: #0f1a2e; color: var(--ink-0);
      transition: transform .05s ease, box-shadow .2s ease, border-color .2s ease;
    }
    button.primary {
      background: linear-gradient(180deg,#0e87c7,#0c6aa0);
      border-color: rgba(34,211,238,.55);
      box-shadow: 0 6px 24px rgba(14,165,233,.35);
    }
    button:hover { transform: translateY(-1px); }
    button:disabled { opacity: .6; cursor: not-allowed; filter: saturate(.6); }

    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    thead th {
      text-align: left; padding: 12px 10px; background: var(--bg-2);
      border-bottom: 1px solid rgba(148,163,184,.25);
    }
    td { padding: 12px 10px; border-bottom: 1px solid rgba(148,163,184,.12); color: var(--ink-0); }

    .status {
      display: inline-flex; align-items: center; gap: 8px;
      font-weight: 700; padding: 4px 10px; border-radius: 999px;
      font-size: 13px; color: #fff;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(148,163,184,.25);
    }
    .s-dot { width: 8px; height: 8px; border-radius: 50%; }
    .Completed .s-dot { background: var(--ok); animation: pulse 2s ease-out infinite; }
    .InProgress .s-dot { background: var(--warn); }
    .NotStarted .s-dot { background: var(--err); animation: pulse 2s ease-out infinite; }

    pre {
      white-space: pre-wrap; word-break: break-word;
      background: #0b1222; color: #dbeafe;
      padding: 12px; border-radius: 12px;
      border: 1px solid rgba(148,163,184,.2);
      max-height: 420px; overflow: auto;
    }

    .chip {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(148,163,184,.25);
      background: rgba(255,255,255,.04); font-weight: 600;
    }
    .upnext {
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
      padding: 10px 12px; border-radius: 10px;
      border: 1px dashed rgba(34,211,238,.35);
      background: rgba(14,165,233,.10); margin-top: 10px;
    }

    #launchInfo { font-size: 14px; color: var(--ink-1); margin-top: 6px; }
  </style>
</head>

<body>
    <header>
        <div class="title-row">
            <h1>Analyzing your progress</h1>
            <span class="badge"><span class="dot" id="connDot"></span><span id="connText">Checking connection…</span></span>
        </div>
    </header>

    <main class="wrap">
        <section class="card" id="info">
            <div><b>Learner:</b> <span id="learnerNameLabel">—</span></div>
            <div class="muted">Session: <span id="sessionLabel">—</span></div>
            <div id="anonWarn" class="muted" style="color:var(--err);display:none;">Actions are disabled until a learner is provided.</div>
        </section>

        <section class="card" id="summaryCard">
            <div class="summary" id="summaryLine">Ready to continue your adaptive journey.</div>
            <div class="upnext">
                <strong>Up Next:</strong>
                <span id="upNextComp" class="chip"><strong>—</strong></span>
                <span id="upNextSub" class="chip"><strong>—</strong></span>
                <span id="upNextType" class="chip"><strong>—</strong></span>
            </div>
            <div id="launchInfo">Click <b>Continue</b> when you’re ready to move on.</div>
        </section>

        <section class="card" id="actions">
            <div class="row">
                <button id="continueBtn" class="primary" disabled>Continue</button>
                <button id="acceptBtn" disabled>Accept Mastery Level and Move On</button>
                <button id="toggleDebug" aria-pressed="false">Show Debug Info</button>
                <button id="resetBtn" style="background:linear-gradient(180deg,#5b6470,#3e4650);border-color:rgba(148,163,184,.55);">Reset Learner</button>
            </div>
        </section>

        <section class="card" id="progress">
            <h3>Your Progress</h3>
            <p class="muted">Real-time data from your learning record.</p>
            <table>
                <thead><tr><th>Competency</th><th>Mastery Level</th><th>Status</th></tr></thead>
                <tbody id="progressTable"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody>
            </table>
        </section>

        <section class="card" id="debug" style="display:none;"></section>
    </main>

    <script>
const BASE = "https://www.wirelearningsolutions.com/";
const PROXY_URL = "https://kh2do5aivc7hqegavqjeiwmd7q0smjqq.lambda-url.us-east-1.on.aws";
const NS = "https://acbl.wirelearningsolutions.com/extensions/";
const EX = k => NS + k;
const REFRESH_MS = 15000;

const qs = new URLSearchParams(location.search);
const learnerName = (qs.get("learnerName") || localStorage.getItem("learnerName") || "Anonymous").trim();
const sid = qs.get("sid") || localStorage.getItem("sessionId") || crypto.randomUUID();
const hintedComp = (qs.get("current") || "").toUpperCase();
if (hintedComp) localStorage.setItem("currentCompetency", hintedComp);
let currentComp = (localStorage.getItem("currentCompetency") || "C1").toUpperCase();

localStorage.setItem("learnerName", learnerName);
localStorage.setItem("sessionId", sid);

// ---------- Connection Check ----------
async function checkConnection() {
  const dot = document.getElementById("connDot");
  const txt = document.getElementById("connText");
  try {
    const r = await fetch(`${PROXY_URL}?learner=__ping__`, { method: "GET" });
    const text = await r.text();
    if (r.ok && text.includes("Lambda")) {
      dot.classList.add("ok");
      txt.textContent = "Connected";
    } else {
      txt.textContent = `Unstable (${r.status})`;
      dot.style.background = "var(--warn)";
    }
  } catch (err) {
    console.error("❌ Ping error:", err);
    txt.textContent = "Offline";
    dot.style.background = "var(--err)";
  }
}

// ---------- Fetch summarized learner progress ----------
async function fetchSummary() {
  try {
    const res = await fetch(`${PROXY_URL}?learner=${encodeURIComponent(learnerName)}&mode=summary`, {
      method: "GET",
      mode: "cors",
      headers: { "Accept": "application/json" }
    });
    const summary = await res.json();
    console.log("📊 LRS Summary:", summary);
    return summary;
  } catch (err) {
    console.error("❌ Summary fetch failed:", err);
    return null;
  }
}

// ---------- Render the Progress Table ----------
function renderProgress(summary) {
  const tbody = document.getElementById("progressTable");
  tbody.innerHTML = "";

  for (const comp of ["C1", "C2", "C3"]) {
    const item = summary[comp] || {};
    const mastery = item.mastery || "—";
    const statusKey = item.completed
      ? "Completed"
      : mastery && mastery !== "—"
      ? "InProgress"
      : "NotStarted";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${comp}</td>
      <td>${mastery}</td>
      <td>
        <span class="status ${statusKey}">
          <span class="s-dot"></span>${statusKey}
        </span>
      </td>`;
    tbody.appendChild(tr);
  }
}

// ---------- Send “finalized” statement ----------
async function sendFinalizeStatement(current) {
  const stmt = {
    actor: { name: learnerName, mbox: `mailto:${encodeURIComponent(learnerName)}@wirelxdfirm.com` },
    verb: { id: "http://id.tincanapi.com/verb/completed", display: { "en-US": "completed" } },
    object: { id: `https://acbl.wirelearningsolutions.com/activities/${current}/offramp` },
    result: {
      completion: true,
      extensions: {
        [EX("learnerName")]: learnerName,
        [EX("finalized")]: true,
        [EX("competencyId")]: current,
        [EX("masteryLevel")]: window.__MASTERY__ || "Unknown"
      }
    }
  };

  await fetch(`${PROXY_URL}?mode=write`, {
    method: "POST",
    mode: "cors",
    headers: {
      "Accept": "application/json",
      "Content-Type": "application/json"
    },
    body: JSON.stringify(stmt)
  });

  localStorage.setItem(`${current}.finalized`, "true");
}

// ---------- Determine next step ----------
function getNextCompetency(summary) {
  const order = ["C1", "C2", "C3"];
  for (const comp of order) {
    if (!summary[comp]?.completed) return comp;
  }
  return "program-complete";
}

// ---------- Launch routing ----------
function launchTarget(targetKey) {
  const href = resolveTargetUrl(targetKey);
  if (!href) { alert(`No route found for ${targetKey}`); return; }
  const url = new URL(href);
  url.searchParams.set("learnerName", learnerName);
  url.searchParams.set("sid", sid);
  window.location.href = url.toString();
}

function resolveTargetUrl(targetKey) {
  if (/-test$/i.test(targetKey)) return `${BASE}${targetKey.split("-")[0].toUpperCase()}-test/story.html`;
  if (/-content$/i.test(targetKey)) return `${BASE}content/${targetKey}.html`;
  if (/-apply$/i.test(targetKey)) return `${BASE}apply/${targetKey}.html`;
  if (/program-complete/i.test(targetKey)) return `${BASE}thanks.html`;
  return null;
}

// ---------- Refresh and Populate ----------
async function refreshAll() {
  await checkConnection();
  document.getElementById("learnerNameLabel").textContent = learnerName;
  document.getElementById("sessionLabel").textContent = sid;

  const summary = await fetchSummary();
  if (!summary) return;

  renderProgress(summary);

  const nextComp = getNextCompetency(summary);
  localStorage.setItem("currentCompetency", nextComp);

  document.getElementById("upNextComp").textContent = nextComp;
  document.getElementById("upNextSub").textContent = summary[nextComp]?.mastery || "—";
  document.getElementById("upNextType").textContent = summary[nextComp]?.completed ? "Review" : "Test";

  // --- Enable buttons ---
  const continueBtn = document.getElementById("continueBtn");
  continueBtn.disabled = learnerName === "Anonymous";
  continueBtn.onclick = () => launchTarget(`${nextComp}-test`);

  const acceptBtn = document.getElementById("acceptBtn");
  acceptBtn.onclick = async () => {
    await sendFinalizeStatement(nextComp);
    launchTarget(`${nextComp}-test`);
  };
}

refreshAll();
setInterval(() => {
  if (document.visibilityState === "visible") refreshAll();
}, REFRESH_MS);
    </script>

</body>
</html>
