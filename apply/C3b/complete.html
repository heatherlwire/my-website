<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Lesson Complete</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <style>
        body {
            margin: 0;
            padding: 40px;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
            background: #0a0f1a;
            color: #e8f1ff;
            text-align: center;
        }

        .msg {
            font-size: 1.2rem;
            opacity: .9;
        }
    </style>
</head>

<body>
    <h2>Finishing up…</h2>
    <p class="msg">Preparing your next step.</p>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {

            /* ----------------------------------------------
                1. Extract context from URL
            ------------------------------------------------*/
            const qs = new URLSearchParams(location.search);
            const targetKey = qs.get("target") || "unknown-apply";

            /* ----------------------------------------------
                2. Get learner identity + competency
            ------------------------------------------------*/
            const learnerName = (localStorage.getItem("learnerName") || "Anonymous").trim();
            const sid = localStorage.getItem("sessionId") || crypto.randomUUID();
            const comp = (localStorage.getItem("currentCompetency") || "C1").toUpperCase();

            /* Cosmetic-only flag so next.html can show "completed" */
            localStorage.setItem(targetKey + ".completed", "true");

            /* ----------------------------------------------
                3. Build xAPI completion statement
            ------------------------------------------------*/
            const stmt = {
                actor: {
                    name: learnerName,
                    mbox: `mailto:${encodeURIComponent(learnerName)}@wirelxdfirm.com`
                },
                verb: {
                    id: "http://adlnet.gov/expapi/verbs/completed",
                    display: { "en-US": "completed" }
                },
                object: {
                    id: `${location.origin}/activities/${targetKey}`,
                    definition: { name: { "en-US": `${targetKey.toUpperCase()} Lesson` } }
                },
                result: {
                    completion: true,
                    extensions: {
                        "https://acbl.wirelearningsolutions.com/extensions/targetKey": targetKey,
                        "https://acbl.wirelearningsolutions.com/extensions/competencyId": comp,
                        "https://acbl.wirelearningsolutions.com/extensions/sessionId": sid
                    }
                },
                timestamp: new Date().toISOString()
            };

            /* ----------------------------------------------
                4. Send to your Lambda proxy (safe if offline)
            ------------------------------------------------*/
            try {
                await fetch(
                    "https://kh2do5aivc7hqegavqjeiwmd7q0smjqq.lambda-url.us-east-1.on.aws?mode=write",
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(stmt)
                    }
                );
            } catch (e) {
                console.warn("Offline or LRS error:", e);
            }

            /* ----------------------------------------------
                5. Redirect automatically to next.html
            ------------------------------------------------*/
            const nextUrl = new URL("https://www.wirelearningsolutions.com/next.html");
            nextUrl.searchParams.set("learnerName", learnerName);
            nextUrl.searchParams.set("sid", sid);
            nextUrl.searchParams.set("current", comp);

            setTimeout(() => {
                window.location.href = nextUrl.toString();
            }, 1000);
        });
    </script>

</body>
</html>
