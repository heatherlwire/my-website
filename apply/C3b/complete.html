<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Lesson Completed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
            background: #07101e;
            color: #e8f1ff;
            padding: 20px;
        }

        .card {
            padding: 16px;
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        button {
            padding: 10px 16px;
            border-radius: 8px;
            background: #0e87c7;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        pre {
            background: #0b1222;
            padding: 12px;
            border-radius: 12px;
            overflow-x: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>

<body>

    <div class="card">
        <h2>Apply Lesson Completed</h2>
        <p>This lesson was marked as complete.</p>
        <p><strong id="modName">—</strong></p>
        <p id="statusText">Saving progress…</p>
        <p>Redirecting back in <span id="count">3</span> seconds.</p>
        <button id="goBtn">Continue Now</button>
    </div>

    <div class="card">
        <button id="dbgBtn">Show debug</button>
        <div id="dbgPanel" style="display:none;">
            <pre id="dbgOut">Waiting…</pre>
        </div>
    </div>

    <script>
        (function () {

            /* -----------------------
               Query & Identity
            ----------------------- */
            const qs = new URLSearchParams(location.search);
            const target = qs.get("target") || "unknown";

            const learnerName =
                qs.get("learnerName") ||
                localStorage.getItem("learnerName") ||
                "Anonymous";

            let sid =
                qs.get("sid") ||
                localStorage.getItem("sessionId") ||
                (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));

            localStorage.setItem("learnerName", learnerName);
            localStorage.setItem("sessionId", sid);

            /* Detect competency */
            const compMatch = target.match(/C[1-3]/i);
            const comp = compMatch ? compMatch[0].toUpperCase() : "C1";
            localStorage.setItem("currentCompetency", comp);

            /* Normalize subCompetency (C1b-apply → C1b) */
            let subCompetency = "unknown";
            try {
                const m = target.match(/C[1-3][a-c]/i);
                if (m) subCompetency = m[0].toUpperCase();
            } catch (e) { }

            const fullPath = `/apply/${subCompetency}/${subCompetency}-apply.html`;
            localStorage.setItem("lastPath", fullPath);

            document.getElementById("modName").textContent = target.toUpperCase();

            /* -----------------------
               NEXT PAGE
            ----------------------- */
            const nextURL = new URL("https://www.wirelearningsolutions.com/next.html");
            nextURL.searchParams.set("learnerName", learnerName);
            nextURL.searchParams.set("sid", sid);
            nextURL.searchParams.set("current", comp);

            /* -----------------------
               xAPI STATEMENT
            ----------------------- */
            const PROXY = "https://kh2do5aivc7hqegavqjeiwmd7q0smjqq.lambda-url.us-east-1.on.aws";

            const NS = "https://acbl.wirelxdfirm.com/extensions/";
            const EX = k => NS + k;

            const stmt = {
                actor: {
                    name: learnerName,
                    mbox: "mailto:" + encodeURIComponent(learnerName) + "@wirelxdfirm.com"
                },
                verb: {
                    id: "http://adlnet.gov/expapi/verbs/completed",
                    display: { "en-US": "completed" }
                },
                object: {
                    id: `https://acbl.wirelxdfirm.com/activities/${target}`,
                    definition: {
                        name: { "en-US": `${target} Apply Lesson` },
                        type: "http://adlnet.gov/expapi/activities/lesson"
                    }
                },
                result: {
                    completion: true,
                    extensions: {
                        [EX("competencyId")]: comp,
                        [EX("subCompetency")]: subCompetency,
                        [EX("targetKey")]: target,
                        [EX("sessionId")]: sid,
                        [EX("applyComplete")]: true
                    }
                },
                context: { registration: sid },
                timestamp: new Date().toISOString()
            };

            (async () => {
                try {
                    await fetch(PROXY + "?mode=write", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(stmt)
                    });
                    document.getElementById("statusText").textContent = "Progress recorded";
                } catch (e) {
                    document.getElementById("statusText").textContent = "Saved offline";
                }

                document.getElementById("dbgOut").textContent = JSON.stringify(
                    { learnerName, sid, comp, ta
