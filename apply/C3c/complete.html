<script>
    (function () {

        /* -----------------------
           Query & Identity
        ----------------------- */
        const qs = new URLSearchParams(location.search);
        const target = qs.get("target") || "unknown";

        const learnerName =
            qs.get("learnerName") ||
            localStorage.getItem("learnerName") ||
            "Anonymous";

        let sid =
            qs.get("sid") ||
            localStorage.getItem("sessionId") ||
            (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));

        localStorage.setItem("learnerName", learnerName);
        localStorage.setItem("sessionId", sid);

        /* Detect competency */
        const compMatch = target.match(/C[1-3]/i);
        const comp = compMatch ? compMatch[0].toUpperCase() : "C1";
        localStorage.setItem("currentCompetency", comp);

        /* Normalize subCompetency (C1b-apply → C1b) */
        let subCompetency = "unknown";
        try {
            const m = target.match(/C[1-3][a-c]/i);
            if (m) subCompetency = m[0].toUpperCase();
        } catch (e) { }

        const fullPath = `/apply/${subCompetency}/${subCompetency}-apply.html`;
        localStorage.setItem("lastPath", fullPath);

        document.getElementById("modName").textContent = target.toUpperCase();

        /* -----------------------
           NEXT PAGE
        ----------------------- */
        const nextURL = new URL("https://www.wirelearningsolutions.com/next.html");
        nextURL.searchParams.set("learnerName", learnerName);
        nextURL.searchParams.set("sid", sid);
        nextURL.searchParams.set("current", comp);

        /* -----------------------
           xAPI STATEMENT
        ----------------------- */
        const PROXY = "https://kh2do5aivc7hqegavqjeiwmd7q0smjqq.lambda-url.us-east-1.on.aws";

        const NS = "https://acbl.wirelxdfirm.com/extensions/";
        const EX = k => NS + k;

        const stmt = {
            actor: {
                name: learnerName,
                mbox: "mailto:" + encodeURIComponent(learnerName) + "@wirelxdfirm.com"
            },
            verb: {
                id: "http://adlnet.gov/expapi/verbs/completed",
                display: { "en-US": "completed" }
            },
            object: {
                id: `https://acbl.wirelxdfirm.com/activities/${target}`,
                definition: {
                    name: { "en-US": `${target} Apply Lesson` },
                    type: "http://adlnet.gov/expapi/activities/lesson"
                }
            },
            result: {
                completion: true,
                extensions: {
                    [EX("competencyId")]: comp,
                    [EX("subCompetency")]: subCompetency,   // <--- REQUIRED
                    [EX("targetKey")]: target,
                    [EX("sessionId")]: sid,
                    [EX("applyComplete")]: true
                }
            },
            context: {
                registration: sid
            },
            timestamp: new Date().toISOString()
        };

        (async () => {
            try {
                await fetch(PROXY + "?mode=write", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(stmt)
                });
                document.getElementById("statusText").textContent = "Progress recorded";
            } catch (e) {
                document.getElementById("statusText").textContent = "Saved offline";
            }

            document.getElementById("dbgOut").textContent =
                JSON.stringify(
                    { learnerName, sid, comp, target, subCompetency, fullPath, next: nextURL.toString() },
                    null,
                    2
                );
        })();

        /* -----------------------
           AUTO REDIRECT
        ----------------------- */
        let t = 3;
        const counter = document.getElementById("count");
        const timer = setInterval(() => {
            t--;
            counter.textContent = t;
            if (t <= 0) {
                clearInterval(timer);
                location.href = nextURL.toString();
            }
        }, 1000);

        document.getElementById("goBtn").onclick = () => {
            clearInterval(timer);
            location.href = nextURL.toString();
        };

        document.getElementById("dbgBtn").onclick = () => {
            const p = document.getElementById("dbgPanel");
            const v = p.style.display === "block";
            p.style.display = v ? "none" : "block";
            document.getElementById("dbgBtn").textContent = v ? "Show debug" : "Hide debug";
        };

    })();
</script>
