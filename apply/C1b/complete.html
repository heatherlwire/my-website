<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Lesson Complete</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
        :root {
            --bg-0: #0a0f1a;
            --bg-1: #0e1526;
            --ink-0: #e8f1ff;
            --ink-1: #b9c8e8;
            --sky-1: #0ea5e9;
            --ok: #22c55e;
            --shadow: 0 12px 32px rgba(0,0,0,.45);
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
            background: radial-gradient(1400px 900px at 70% -10%, rgba(34,211,238,.10), transparent 60%), radial-gradient(1200px 700px at -10% 20%, rgba(14,165,233,.15), transparent 55%), linear-gradient(180deg, #07101e 0%, #0a1322 50%, #0b1628 100%);
            color: var(--ink-0);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .card {
            background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)), var(--bg-1);
            border-radius: 18px;
            border: 1px solid rgba(148,163,184,.25);
            box-shadow: var(--shadow);
            padding: 28px 32px;
            max-width: 540px;
            width: 100%;
            text-align: center;
        }

        h1 {
            margin: 0 0 16px;
            font-size: 28px;
            font-weight: 700;
        }

        p {
            margin: 8px 0 16px;
            color: var(--ink-1);
            font-size: 18px;
            line-height: 1.5;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            padding: 10px 16px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,.4);
            background: rgba(15,23,42,.9);
            font-size: 16px;
            font-weight: 600;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 999px;
            background: var(--ok);
            box-shadow: 0 0 0 0 rgba(34,197,94,.6);
            animation: pulse 1.8s ease-out infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(34,197,94,.5);
            }

            70% {
                box-shadow: 0 0 0 14px rgba(34,197,94,0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(34,197,94,0);
            }
        }

        .small {
            margin-top: 10px;
            font-size: 15px;
            color: var(--ink-1);
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>Lesson Complete</h1>
        <p id="msg">Saving your progress and updating your dashboard.</p>
        <div class="pill">
            <span class="dot"></span>
            <span id="pillLabel">Sending data to LRS…</span>
        </div>
        <p class="small" id="detail"></p>
    </div>

    <script>
        /* ============================================================
           CONFIG
        ============================================================ */
        const PROXY_URL =
            "https://kh2do5aivc7hqegavqjeiwmd7q0smjqq.lambda-url.us-east-1.on.aws";

        const EXT_NS = "https://acbl.wirelxdfirm.com/extensions/";
        const EX = k => EXT_NS + k;

        /* ============================================================
           IDENTITY
        ============================================================ */
        const qs = new URLSearchParams(location.search);

        let target = qs.get("target") || "";
        let learnerName =
            qs.get("learnerName") || localStorage.getItem("learnerName") || "";
        let email =
            qs.get("email") || localStorage.getItem("learnerEmail") || "";
        let sid =
            qs.get("sid") || localStorage.getItem("sessionId") || "";

        if (!sid) {
            sid = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());
        }

        if (learnerName) localStorage.setItem("learnerName", learnerName);
        if (email) localStorage.setItem("learnerEmail", email);
        localStorage.setItem("sessionId", sid);

        /* ============================================================
           FORCE ROOT NEXT PAGE
        ============================================================ */
        function withIdentity(url) {
            const sep = url.includes("?") ? "&" : "?";
            return url + sep +
                "learnerName=" + encodeURIComponent(learnerName || "") +
                "&email=" + encodeURIComponent(email || "") +
                "&sid=" + encodeURIComponent(sid || "");
        }

        /* ============================================================
           PARSE target → compId / subId / mode
        ============================================================ */
        function deriveIds(target) {
            const m = target.match(/C([1-3][a-c])/i);
            if (!m) return { compId: null, subId: null, mode: null };

            const raw = "C" + m[1];        // C1a
            const subId = raw.toUpperCase(); // C1A
            const compId = "C" + subId.charAt(1);

            let mode = /content/i.test(target) ? "content" : "apply";

            return { compId, subId, mode };
        }

        /* ============================================================
           SEND STATEMENT
        ============================================================ */
        async function sendStatement() {
            const msgEl = document.getElementById("msg");
            const pillLabel = document.getElementById("pillLabel");
            const detail = document.getElementById("detail");

            const { compId, subId, mode } = deriveIds(target);

            console.log("Complete page:", { target, compId, subId, mode });

            if (!subId) {
                msgEl.textContent = "We could not identify the lesson you completed.";
                pillLabel.textContent = "Return to dashboard manually.";
                return;
            }

            const actorName = learnerName || email || "Anonymous";
            const mbox = "mailto:" + encodeURIComponent(actorName) + "@wirelxdfirm.com";

            const verbId =
                mode === "apply"
                    ? "http://adlnet.gov/expapi/verbs/completed"
                    : "http://adlnet.gov/expapi/verbs/experienced";

            const verbLabel =
                mode === "apply"
                    ? "completed application"
                    : "experienced content";

            const activityId =
                mode === "apply"
                    ? `https://acbl.wirelxdfirm.com/activities/${subId}/apply`
                    : `https://acbl.wirelxdfirm.com/activities/${subId}/content`;

            const displayName =
                mode === "apply"
                    ? `${subId} Apply Completed`
                    : `${subId} Content Completed`;

            const stmt = {
                actor: {
                    name: actorName,
                    mbox: mbox
                },
                verb: {
                    id: verbId,
                    display: { "en-US": verbLabel }
                },
                object: {
                    id: activityId,
                    definition: {
                        name: { "en-US": displayName },
                        type: "http://adlnet.gov/expapi/activities/lesson"
                    },
                    objectType: "Activity"
                },
                result: {
                    completion: true,
                    success: true,
                    extensions: {
                        [EX("competencyId")]: compId,
                        [EX("subCompetency")]: subId,
                        [EX("learnerName")]: actorName
                    }
                },
                context: { registration: sid },
                timestamp: new Date().toISOString()
            };

            console.log("Sending xAPI:", stmt);

            try {
                pillLabel.textContent = "Sending data to LRS…";

                const r = await fetch(PROXY_URL + "?mode=write", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(stmt)
                });

                if (!r.ok) throw new Error("LRS write failed: " + r.status);

                pillLabel.textContent = "Saved! Redirecting…";
                detail.textContent = `${subId} (${mode}) recorded.`;

                setTimeout(() => {
                    window.location.href = withIdentity("/next.html");
                }, 1500);

            } catch (err) {
                msgEl.textContent = "We had trouble saving your progress.";
                pillLabel.textContent = "Please try again.";
                detail.textContent = String(err);
                console.error(err);
            }
        }

        /* ============================================================
           START
        ============================================================ */
        sendStatement().catch(console.error);

    </script>
</body>
</html>
