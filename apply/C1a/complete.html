<script>
    (function () {
        /* ---------------------------------------------
           Query & identity
        --------------------------------------------- */
        const qs = new URLSearchParams(location.search);
        const target = (qs.get("target") || "unknown").toLowerCase();

        const learnerName = qs.get("learnerName") || localStorage.getItem("learnerName") || "Anonymous";
        let sid = qs.get("sid") || localStorage.getItem("sessionId") || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));

        localStorage.setItem("learnerName", learnerName);
        localStorage.setItem("sessionId", sid);

        const compMatch = target.match(/c[1-3]/i);
        const comp = compMatch ? compMatch[0].toLowerCase() : "c1";
        localStorage.setItem("currentCompetency", comp);

        let subCompetency = "unknown";
        const sm = target.match(/c[1-3][a-c]/i);
        if (sm) subCompetency = sm[0].toLowerCase();

        document.getElementById("modName").textContent = target.toUpperCase();

        /* ---------------------------------------------
           NEXT PAGE routing
        --------------------------------------------- */
        const nextURL = new URL("https://www.wirelearningsolutions.com/next.html");
        nextURL.searchParams.set("learnerName", learnerName);
        nextURL.searchParams.set("sid", sid);
        nextURL.searchParams.set("current", comp);

        /* ---------------------------------------------
           xAPI statement (with mastery and finalized updates)
        --------------------------------------------- */
        const PROXY = "https://kh2do5aivc7hqegavqjeiwmd7q0smjqq.lambda-url.us-east-1.on.aws";

        const NS = "https://acbl.wirelxdfirm.com/extensions/";
        const EX = k => NS + k;

        const stmt = {
            actor: {
                name: learnerName,
                mbox: "mailto:" + encodeURIComponent(learnerName) + "@wirelxdfirm.com"
            },
            verb: {
                id: "http://adlnet.gov/expapi/verbs/completed",
                display: { "en-US": "completed" }
            },
            object: {
                id: `https://acbl.wirelxdfirm.com/activities/${target}`,
                definition: {
                    name: { "en-US": `${target} Apply Lesson` },
                    type: "http://adlnet.gov/exp
