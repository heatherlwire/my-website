<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Canonical redirect -->
    <script>
        if (window.top === window.self) {
            if (location.hostname === "wirelearningsolutions.com") {
                location.replace("https://www.wirelearningsolutions.com" + location.pathname + location.search);
            }
        }
    </script>

    <meta charset="UTF-8" />
    <title>Lesson Complete</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <style>
        :root {
            --bg-1: #0e1526;
            --bg-2: #0f1b33;
            --ink-0: #e8f1ff;
            --ink-1: #b9c8e8;
            --sky-1: #0ea5e9;
            --shadow: 0 10px 24px rgba(0,0,0,.35);
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: radial-gradient(1200px 800px at 70% -10%, rgba(34,211,238,.10), transparent 60%), radial-gradient(1000px 600px at -10% 20%, rgba(14,165,233,.15), transparent 55%), linear-gradient(180deg,#07101e 0%,#0a1322 50%,#0b1628 100%);
            color: var(--ink-0);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 24px;
        }

        .card {
            width: min(480px, 95vw);
            background: linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015)),var(--bg-1);
            border: 1px solid rgba(148,163,184,.15);
            border-radius: 16px;
            padding: 22px 24px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        h1 {
            margin: 0 0 10px;
            font-size: 28px;
            background: linear-gradient(90deg,var(--ink-0),#cfe8ff);
            -webkit-background-clip: text;
            color: transparent;
        }

        p {
            margin: 6px 0 12px;
            color: var(--ink-1);
        }

        button {
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            border: 1px solid rgba(148,163,184,.35);
            background: #0f1a2e;
            color: var(--ink-0);
            margin-top: 12px;
            width: 100%;
        }

            button:hover {
                background: #0e87c7;
                border-color: #22d3ee;
                box-shadow: 0 6px 20px rgba(14,165,233,.35);
            }
    </style>
</head>

<body>
    <section class="card">
        <h1 id="title">Lesson Complete</h1>
        <p id="desc">Your progress has been saved and your adaptive route is updating.</p>

        <button id="nextBtn">Continue</button>
    </section>

    <script>
        /* ============================================================
           1. Detect which apply lesson completed (from ?target=C1a-apply)
        ============================================================ */
        const qs = new URLSearchParams(location.search);
        const target = qs.get("target") || "";            // C1a-apply
        const learnerName = qs.get("learnerName") || localStorage.getItem("learnerName") || "Anonymous";
        const sid = qs.get("sid") || localStorage.getItem("sessionId") || (crypto.randomUUID?.() || Date.now());

        localStorage.setItem("learnerName", learnerName);
        localStorage.setItem("sessionId", sid);

        /* Parse apply name → C1a */
        const m = target.match(/^(C[1-3])([a-c])\-apply$/i);
        if (!m) console.warn("Invalid target param:", target);

        const compId = m ? m[1].toUpperCase() : "C1";
        const subCompetency = m ? (m[1] + m[2]).toUpperCase() : "C1A";

        document.getElementById("title").textContent = subCompetency + " Apply Completed";
        document.getElementById("desc").textContent =
            "You've finished the application lesson. Your adaptive path has been updated and your progress is being tracked.";

        /* ============================================================
           2. LRS CONFIG
        ============================================================ */
        const endpoint =
            "https://cloud.scorm.com/lrs/TENBKY6BZ6/sandbox/statements";
        const auth = "Basic " + btoa("d_cPqAqYNvM3sMTyJ2M:rh70yfaxONPyu11z_vk");

        const NS = "https://acbl.wirelxdfirm.com/extensions/";
        const EX = k => NS + k;

        /* ============================================================
           3. Send apply-completed XAPI
        ============================================================ */
        function sendApplyCompletion() {
            return fetch(endpoint, {
                method: "POST",
                headers: {
                    "Authorization": auth,
                    "Content-Type": "application/json",
                    "X-Experience-API-Version": "1.0.3"
                },
                body: JSON.stringify({
                    actor: {
                        name: learnerName,
                        mbox: `mailto:${encodeURIComponent(learnerName)}@wirelxdfirm.com`
                    },
                    verb: {
                        id: "http://adlnet.gov/expapi/verbs/completed",
                        display: { "en-US": "completed apply" }
                    },
                    object: {
                        id: `https://acbl.wirelxdfirm.com/activities/${target}`
                    },
                    result: {
                        extensions: {
                            [EX("learnerName")]: learnerName,
                            [EX("sessionId")]: sid,
                            [EX("competencyId")]: compId,
                            [EX("subCompetency")]: subCompetency,
                            [EX("subCompleted")]: true,
                            [EX("completion")]: true,
                            [EX("success")]: true
                        }
                    },
                    timestamp: new Date().toISOString()
                })
            });
        }

        sendApplyCompletion();

        /* ============================================================
           4. Continue → back to next.html
        ============================================================ */
        document.getElementById("nextBtn").addEventListener("click", () => {
            const u = new URL("https://www.wirelearningsolutions.com/next.html");
            u.searchParams.set("learnerName", learnerName);
            u.searchParams.set("sid", sid);
            u.searchParams.set("source", subCompetency);
            location.href = u.toString();
        });
    </script>
</body>
</html>
