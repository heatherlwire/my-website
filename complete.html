<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Lesson Complete</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root {
            --bg-0: #0a0f1a;
            --bg-1: #0e1526;
            --ink-0: #e8f1ff;
            --ink-1: #b9c8e8;
            --sky-1: #0ea5e9;
            --ok: #22c55e;
            --warn: #f59e0b;
            --shadow: 0 10px 24px rgba(0,0,0,.35);
        }

        body {
            margin: 0;
            color: var(--ink-0);
            font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
            background: radial-gradient(1000px 600px at 70% -10%,rgba(34,211,238,.10),transparent 60%),linear-gradient(180deg,#07101e 0%,#0a1322 50%,#0b1628 100%);
            min-height: 100dvh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .card {
            background: linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.015)),var(--bg-1);
            border: 1px solid rgba(148,163,184,.15);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 28px 24px;
            backdrop-filter: blur(6px);
            max-width: 640px;
            text-align: center;
        }

        h1 {
            font-size: clamp(22px,2.4vw,28px);
            margin-bottom: 10px;
            background: linear-gradient(90deg,var(--ink-0),#cfe8ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 999px;
            border: 1px solid rgba(34,211,238,.45);
            background: rgba(14,165,233,.10);
            margin-bottom: 14px;
        }

        .dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--ok);
            box-shadow: 0 0 0 0 rgba(34,197,94,.55);
            animation: pulse 1.8s ease-out infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(34,197,94,.5)
            }

            70% {
                box-shadow: 0 0 0 10px rgba(34,197,94,0)
            }

            100% {
                box-shadow: 0 0 0 0 rgba(34,197,94,0)
            }
        }

        .muted {
            color: var(--ink-1);
        }

        .module {
            font-weight: 700;
            color: #d8ecff;
        }

        .row {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border-radius: 10px;
            border: 1px solid rgba(148,163,184,.35);
            background: #0f1a2e;
            color: var(--ink-0);
            cursor: pointer;
            font-size: 14px;
        }

        pre {
            white-space: pre-wrap;
            word-break: break-word;
            background: #0b1222;
            color: #dbeafe;
            border: 1px solid rgba(148,163,184,.2);
            border-radius: 12px;
            padding: 12px;
            max-height: 260px;
            overflow: auto;
            margin-top: 12px;
            text-align: left;
        }
    </style>
</head>
<body>
    <section class="card">
        <div class="badge"><span class="dot"></span><span id="statusText">Recording completion…</span></div>
        <h1>Lesson Complete</h1>
        <p class="muted">You just finished <span class="module" id="moduleName">—</span></p>
        <p class="muted small">Redirecting to your next step in <span id="count">3</span> seconds…</p>

        <div class="row">
            <button id="viewDebug" class="btn" aria-pressed="false">Show debug</button>
            <button id="continueBtn" class="btn">Go now</button>
        </div>

        <div id="debugPanel" style="display:none">
            <pre id="debugOut">Loading…</pre>
        </div>
    </section>

    <script>
        (function () {
            try {
                // --- record current page path (e.g., "apply/complete.html") ---
                var path = (location && location.pathname ? location.pathname : "").replace(/^\/+/, "");
                if (path) localStorage.setItem("lastPath", path);

                // --- infer current competency (C1/C2/C3) from URL or referrer ---
                var m = path.match(/C([123])/i) || (document.referrer && document.referrer.match(/C([123])/i));
                if (m && m[1]) {
                    localStorage.setItem("currentCompetency", "C" + String(m[1]).toUpperCase());
                }
            } catch (e) {
                try { console.warn("Progress save failed:", e); } catch (_) { }
            }
        })();

        const PROXY_URL = "https://kh2do5aivc7hqegavqjeiwmd7q0smjqq.lambda-url.us-east-1.on.aws";
        const NS = "https://acbl.wirelxdfirm.com/extensions/";
        const EX = k => NS + k;

        const qs = new URLSearchParams(location.search);
        let targetKey = qs.get("target");
        if (!targetKey) {
            const ref = document.referrer || "";
            const m = ref.match(/(C[123][abc])\-(content|apply)/i);
            targetKey = m ? `${m[1]}-${m[2]}` : "C1a-content";
        }

        const comp = (targetKey.match(/(C\d)/i)?.[1] || "C1").toUpperCase();
        const prettyModule = `${targetKey.toUpperCase()} Lesson`;
        document.getElementById("moduleName").textContent = prettyModule;

        const learnerName = localStorage.getItem("learnerName") || "Anonymous";
        const sid = localStorage.getItem("sessionId") || crypto.randomUUID();

        const debugBtn = document.getElementById("viewDebug");
        const debugPanel = document.getElementById("debugPanel");
        const debugOut = document.getElementById("debugOut");
        debugBtn.onclick = () => {
            const open = debugPanel.style.display !== "block";
            debugPanel.style.display = open ? "block" : "none";
            debugBtn.setAttribute("aria-pressed", open ? "true" : "false");
            debugBtn.textContent = open ? "Hide debug" : "Show debug";
        };

        function startCountdown() {
            let t = 3;
            const id = setInterval(() => {
                t -= 1;
                document.getElementById("count").textContent = String(Math.max(t, 0));
                if (t <= 0) { clearInterval(id); goNow(); }
            }, 1000);
        }

        function findNextStep() {
            const missed = JSON.parse(localStorage.getItem(`${comp}.missed`) || "[]");
            const isContent = targetKey.includes("-content");
            const isApply = targetKey.includes("-apply");
            localStorage.setItem(`${targetKey}.completed`, "true");

            if (isContent) {
                return `apply/${targetKey.replace("-content", "-apply")}.html`;
            }
            if (isApply) {
                const remaining = missed.filter(s => !localStorage.getItem(`${s}-apply.completed`));
                if (remaining.length > 0) return `content/${remaining[0]}-content.html`;
                return `${comp}-test/story.html`;
            }
            return "next.html";
        }

        function goNow() {
            const nextStep = findNextStep();
            const url = new URL(`${location.origin}/${nextStep}`);
            url.searchParams.set("learnerName", learnerName);
            url.searchParams.set("sid", sid);
            url.searchParams.set("current", comp);
            localStorage.setItem("lastPath", nextStep);
            location.href = url.toString();
        }

        document.getElementById("continueBtn").onclick = goNow;

        async function sendCompleted() {
            const subType = targetKey.includes("-content") ? "content" : (targetKey.includes("-apply") ? "apply" : "other");

            // Determine status: if there are still missed subs, it's "in progress"; otherwise "completed"
            const missed = JSON.parse(localStorage.getItem(`${comp}.missed`) || "[]");
            const remaining = missed.filter(s => !localStorage.getItem(`${s}-apply.completed`));
            const status = remaining.length > 0 ? "in progress" : "completed";

            const stmt = {
                actor: { name: learnerName, mbox: `mailto:${encodeURIComponent(learnerName)}@wirelxdfirm.com` },
                verb: { id: "http://adlnet.gov/expapi/verbs/completed", display: { "en-US": "completed" } },
                object: {
                    id: `${location.origin}/activities/${targetKey}`,
                    definition: { name: { "en-US": prettyModule }, description: { "en-US": "Lesson completed" } }
                },
                result: {
                    completion: true,
                    extensions: {
                        [EX("learnerName")]: learnerName,
                        [EX("sessionId")]: sid,
                        [EX("targetKey")]: targetKey,
                        [EX("competencyId")]: comp,
                        [EX("subType")]: subType,
                        [EX("status")]: status // ← NEW: tracks learner’s progress state
                    }
                },
                timestamp: new Date().toISOString()
            };

            debugOut.textContent = JSON.stringify({ targetKey, comp, learnerName, sid, subType, status, next: findNextStep() }, null, 2);

            const statusEl = document.getElementById("statusText");
            try {
                const r = await fetch(PROXY_URL + "?mode=write", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(stmt)
                });
                statusEl.textContent = r.ok ? "Progress recorded via Lambda" : `⚠️ Saved locally (LRS ${r.status})`;
            } catch {
                statusEl.textContent = "⚠️ Saved locally (network error)";
            }
            startCountdown();
        }

        document.addEventListener("DOMContentLoaded", sendCompleted);
    </script>
</body>
</html>
