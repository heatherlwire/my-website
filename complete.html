<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Marking Apply Complete…</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        body {
            font-family: system-ui,Segoe UI,Roboto,Arial;
            background: #0b1628;
            color: #e8f1ff;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh
        }
    </style>
</head>
<body>
    <div>Saving your progress…</div>
    <script>
    (async () => {
      // --- LRS config (same as your next.html) ---
      const endpoint = "https://cloud.scorm.com/lrs/TENBKY6BZ6/sandbox/";
      const key = "d_cPqAqYNvM3sMTyJ2M";
      const secret = "rh70yfaxONPyu11z_vk";
      const auth = "Basic " + btoa(`${key}:${secret}`);
      const NS = "https://acbl.wirelxdfirm.com/extensions/";
      const EX = k => NS + k;

      // --- Identity from localStorage ---
      const learnerName = localStorage.getItem("learnerName") || "Anonymous";
      const sid = localStorage.getItem("sessionId") || "";

      // --- Target from query string, e.g., ?target=C1a-apply ---
      const qs = new URLSearchParams(location.search);
      const targetKey = qs.get("target") || "Unknown-apply";

      // Try to infer the competency (C1/C2/C3) from targetKey
      const comp = (targetKey.match(/(C\d)/i)?.[1] || "C1").toUpperCase();

      // xAPI completed for the Apply module
      const stmt = {
        actor: { name: learnerName, mbox: `mailto:${encodeURIComponent(learnerName)}@wirelxdfirm.com` },
        verb: { id: "http://adlnet.gov/expapi/verbs/completed", display: { "en-US": "completed" } },
        object: {
          id: `${location.origin}/apply/${targetKey.split("-")[0]}/`,
          definition: {
            name: { "en-US": `Apply: ${targetKey}` },
            description: { "en-US": "Rise Apply module completed (web export)" }
          }
        },
        result: {
          completion: true,
          extensions: {
            [EX("learnerName")]: learnerName,
            [EX("sessionId")]: sid,
            [EX("targetKey")]: targetKey,
            [EX("competencyId")]: comp
          }
        },
        timestamp: new Date().toISOString()
      };

      try {
        await fetch(endpoint + "statements", {
          method: "POST",
          headers: {
            "Authorization": auth,
            "Content-Type": "application/json",
            "X-Experience-API-Version": "1.0.3"
          },
          body: JSON.stringify(stmt)
        });
        localStorage.setItem(`${targetKey}.completed`, "true");
      } catch(e) {/* non-blocking */}

      // Return to your router
      const back = `${location.origin}/next.html?current=${encodeURIComponent(comp)}`;
      setTimeout(() => location.href = back, 400);
    })();
    </script>
</body>
</html>
